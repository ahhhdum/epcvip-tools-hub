<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating... - EPCVIP Tools Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --text-primary: #ffffff;
            --text-muted: #a0a0a0;
            --accent-yellow: #ffd700;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        .container {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--text-muted);
            border-radius: 50%;
            border-top-color: var(--accent-yellow);
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        h1 { font-size: 20px; margin-bottom: 10px; }
        p { color: var(--text-muted); font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Authenticating...</h1>
        <p>Please wait while we complete your sign-in.</p>
    </div>

    <script>
        const SUPABASE_URL = '{{SUPABASE_URL}}';
        const SUPABASE_ANON_KEY = '{{SUPABASE_ANON_KEY}}';
        const ALLOWED_DOMAIN = '{{ALLOWED_DOMAIN}}';
        const APP_ID = 'tools-hub';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        (async () => {
            try {
                // Let Supabase handle PKCE exchange automatically
                const { data: { session }, error } = await sb.auth.getSession();

                if (error) {
                    console.error('[Auth] Session error:', error);
                    window.location.href = '/login?error=oauth_failed';
                    return;
                }

                if (!session) {
                    console.error('[Auth] No session');
                    window.location.href = '/login?error=oauth_failed';
                    return;
                }

                const email = session.user?.email || '';

                // Validate email domain
                if (!email.toLowerCase().endsWith(`@${ALLOWED_DOMAIN.toLowerCase()}`)) {
                    console.log('[Auth] Domain not allowed:', email);
                    await sb.auth.signOut();
                    window.location.href = '/login?error=domain_not_allowed';
                    return;
                }

                // Check RBAC access
                const { data: roleData, error: roleError } = await sb
                    .from('epcvip_app_roles')
                    .select('role')
                    .eq('app_id', APP_ID)
                    .eq('user_email', email.toLowerCase())
                    .maybeSingle();

                if (roleError) {
                    console.error('[Auth] RBAC check error:', roleError);
                    // Allow access on RBAC error (fail open for now)
                }

                if (!roleData) {
                    console.log('[Auth] No RBAC access for:', email);
                    await sb.auth.signOut();
                    window.location.href = '/login?error=no_access';
                    return;
                }

                // Set SSO cookie with shared domain
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const cookieDomain = isLocalhost ? '' : '; domain=.epcvip.vip';
                const maxAge = 7 * 24 * 60 * 60; // 7 days
                document.cookie = `sb-access-token=${session.access_token}; path=/${cookieDomain}; max-age=${maxAge}; SameSite=Lax${isLocalhost ? '' : '; Secure'}`;

                // Redirect to saved returnUrl or home
                const savedReturnUrl = sessionStorage.getItem('sso_returnUrl');
                sessionStorage.removeItem('sso_returnUrl');

                // Validate returnUrl
                const isValidReturnUrl = (url) => url && url.startsWith('/') && !url.startsWith('//');
                window.location.href = isValidReturnUrl(savedReturnUrl) ? savedReturnUrl : '/';

            } catch (err) {
                console.error('[Auth] Callback error:', err);
                window.location.href = '/login?error=oauth_failed';
            }
        })();
    </script>
</body>
</html>
