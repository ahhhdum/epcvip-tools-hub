<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Editor - EPCVIP Tools Hub</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #16213e;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #0f3460;
    }

    header h1 { font-size: 18px; font-weight: 600; }

    .toolbar { display: flex; gap: 8px; }

    button {
      background: #0f3460;
      color: #eee;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover { background: #1a4a7a; }
    button.active { background: #e94560; }

    .main { display: flex; flex: 1; overflow: hidden; }

    .sidebar {
      width: 360px;
      background: #16213e;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Mode Tabs */
    .mode-tabs {
      display: flex;
      border-bottom: 2px solid #0f3460;
    }

    .mode-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: #0f3460;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .mode-tab:hover { background: #1a4a7a; color: #eee; }
    .mode-tab.active { background: #e94560; color: #fff; }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; }

    /* Tile mode styles */
    .tileset-container {
      border: 2px solid #0f3460;
      border-radius: 4px;
      overflow: hidden;
      background: #333;
    }

    #tilesetCanvas { display: block; cursor: pointer; }

    .selected-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #0f3460;
      border-radius: 4px;
    }

    #selectedPreview, #selectedAssetPreview {
      border: 2px solid #e94560;
      image-rendering: pixelated;
      background: #333;
    }

    .layer-controls { display: flex; flex-direction: column; gap: 6px; }
    .layer-btn { padding: 10px; text-align: left; font-size: 13px; }
    .layer-btn.active { background: #e94560; }

    .controls-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    input[type="number"], input[type="text"], select {
      background: #0f3460;
      border: 1px solid #1a4a7a;
      color: #eee;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
    }

    input[type="text"] { flex: 1; }
    input[type="number"] { width: 70px; }
    input[type="checkbox"] { width: 18px; height: 18px; }

    label { font-size: 13px; color: #aaa; display: flex; align-items: center; gap: 6px; }

    /* Entity mode styles */
    .asset-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .asset-item {
      background: #0f3460;
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .asset-item:hover { background: #1a4a7a; }
    .asset-item.selected { border-color: #e94560; background: #1a4a7a; }

    .asset-item img {
      max-width: 100%;
      max-height: 60px;
      image-rendering: pixelated;
    }

    .asset-item canvas.asset-preview {
      width: 80px;
      height: 60px;
      image-rendering: pixelated;
      background: #1a1a2e;
      border-radius: 2px;
    }

    .asset-item .name {
      font-size: 11px;
      margin-top: 4px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Properties Panel */
    .properties-panel {
      background: #0f3460;
      border-radius: 4px;
      padding: 12px;
    }

    .properties-panel h3 { margin-bottom: 12px; }

    .prop-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .prop-row label { min-width: 80px; color: #888; }
    .prop-row input, .prop-row select { flex: 1; }

    .delete-btn { background: #c0392b; margin-top: 12px; width: 100%; }
    .delete-btn:hover { background: #e74c3c; }

    /* Map area */
    .map-area {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: #111;
      position: relative;
    }

    #mapCanvas {
      border: 2px solid #0f3460;
      cursor: crosshair;
      image-rendering: pixelated;
    }

    .map-info { font-size: 12px; color: #666; }

    /* Bottom bar */
    .bottom-bar {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 8px 16px;
      background: #16213e;
      border-top: 2px solid #0f3460;
    }

    .zoom-controls { display: flex; gap: 4px; align-items: center; }
    .zoom-controls button { padding: 4px 10px; }

    .instructions { font-size: 11px; color: #666; line-height: 1.5; }

    /* Hidden panels */
    .hidden { display: none !important; }

    /* Tileset Builder Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #16213e;
      border: 2px solid #0f3460;
      border-radius: 8px;
      width: 500px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 2px solid #0f3460;
    }

    .modal-header h2 { margin: 0; font-size: 16px; }

    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover { color: #e94560; }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .virtual-tileset-item {
      background: #0f3460;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .virtual-tileset-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .virtual-tileset-name {
      font-weight: 600;
      color: #e94560;
    }

    .virtual-tileset-sources {
      font-size: 12px;
      color: #888;
      padding-left: 12px;
    }

    .virtual-tileset-sources div {
      padding: 2px 0;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }

    .btn-danger { background: #c0392b; }
    .btn-danger:hover { background: #e74c3c; }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      color: #888;
      font-size: 12px;
    }

    .form-group input[type="text"] {
      width: 100%;
    }

    .source-list {
      background: #1a1a2e;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 8px;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }

    .source-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: #0f3460;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .source-item:last-child { margin-bottom: 0; }

    .available-sources {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }

    .available-sources button {
      padding: 4px 8px;
      font-size: 11px;
    }

    .modal-footer {
      padding: 16px;
      border-top: 2px solid #0f3460;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Sprite Slicer Modal */
    .slicer-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .slicer-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slicer-canvas-wrapper {
      background: #1a1a2e;
      border: 2px solid #0f3460;
      border-radius: 4px;
      padding: 16px;
      overflow: auto;
      max-height: 300px;
      margin-bottom: 16px;
    }

    #slicerCanvas {
      cursor: crosshair;
      image-rendering: pixelated;
      display: block;
      margin: 0 auto;
    }

    .slicer-pieces {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      max-height: 150px;
      overflow-y: auto;
    }

    .slicer-piece {
      background: #0f3460;
      border: 2px solid #1a4a7a;
      border-radius: 4px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 80px;
    }

    .slicer-piece canvas {
      image-rendering: pixelated;
      background: #1a1a2e;
      border-radius: 2px;
    }

    .slicer-piece input {
      width: 70px;
      text-align: center;
      font-size: 11px;
    }

    .slicer-piece .piece-info {
      font-size: 10px;
      color: #888;
    }

    .slicer-output {
      background: #1a1a2e;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 12px;
    }

    .slicer-output pre {
      margin: 0;
      font-size: 11px;
      color: #aaa;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
    }

    .slicer-output button {
      margin-bottom: 8px;
    }

    .slicer-hint {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 13px;
      max-width: 320px;
      animation: toast-in 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast-info {
      background: #0f3460;
      border-left: 4px solid #3498db;
    }

    .toast-warn {
      background: #3d3d00;
      border-left: 4px solid #f1c40f;
    }

    .toast-error {
      background: #3d1010;
      border-left: 4px solid #e94560;
    }

    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
  </style>
</head>
<body>
  <!-- Toast notification container -->
  <div id="toastContainer" class="toast-container"></div>

  <header>
    <h1>Map Editor - EPCVIP Tools Hub</h1>
    <div class="toolbar">
      <button id="newMapBtn">New</button>
      <button id="loadJsonBtn">Load</button>
      <button id="saveJsonBtn">Save</button>
      <input type="file" id="fileInput" accept=".json" style="display: none;">
      <input type="file" id="tilesetInput" accept=".png" style="display: none;">
    </div>
  </header>

  <div class="main">
    <div class="sidebar">
      <!-- Mode Tabs -->
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="tiles">Tiles</button>
        <button class="mode-tab" data-mode="entities">Entities</button>
      </div>

      <div class="sidebar-content">
        <!-- TILES MODE -->
        <div id="tilesPanel">
          <div>
            <h3>Tileset</h3>
            <select id="tilesetSelect" style="width: 100%; margin-bottom: 8px; padding: 8px;">
              <option value="">-- Select Tileset --</option>
              <optgroup label="Virtual Tilesets" id="virtualTilesetGroup">
              </optgroup>
              <optgroup label="Raw Tilesets">
                <option value="Grass_Plain">Grass (Plain)</option>
                <option value="Grass_Tiles_1">Grass (Main)</option>
                <option value="Grass_Tiles_2">Grass (Alt 1)</option>
                <option value="Grass_Tiles_3">Grass (Alt 2)</option>
                <option value="Grass_Tiles_4">Grass (Variety)</option>
                <option value="Cobble_Road_1">Cobblestone 1</option>
                <option value="Cobble_Road_2">Cobblestone 2</option>
                <option value="Pavement_Tiles">Pavement</option>
                <option value="Hedge_Tiles">Hedges</option>
              </optgroup>
            </select>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <button id="loadTilesetBtn" style="flex: 1;">Load PNG</button>
              <button id="manageTilesetsBtn" style="flex: 1;">Manage</button>
            </div>
            <div class="tileset-container">
              <canvas id="tilesetCanvas" width="256" height="160"></canvas>
            </div>
          </div>

          <div class="selected-item">
            <canvas id="selectedPreview" width="32" height="32"></canvas>
            <div>
              <div>Selected: <strong id="selectedIndex">0</strong></div>
              <div class="map-info">Click tileset to select</div>
            </div>
          </div>

          <div class="layer-controls">
            <h3>Layers</h3>
            <button class="layer-btn active" data-layer="ground">Ground (z=0)</button>
            <button class="layer-btn" data-layer="paths">Paths (z=1)</button>
            <button class="layer-btn" data-layer="decorations">Decorations (z=2)</button>
          </div>

          <div>
            <h3>Tools</h3>
            <div class="controls-row">
              <button id="eraserBtn">Eraser (E)</button>
              <button id="fillBtn">Fill (F)</button>
            </div>
          </div>
        </div>

        <!-- ENTITIES MODE -->
        <div id="entitiesPanel" class="hidden">
          <div>
            <h3>Entity Type</h3>
            <select id="entityTypeSelect" style="width: 100%; margin-bottom: 8px;">
              <option value="buildings">Buildings</option>
              <option value="decorations">Decorations</option>
              <option value="trees">Trees</option>
            </select>
            <button id="openSlicerBtn" style="width: 100%; margin-bottom: 8px;">Sprite Slicer</button>
          </div>
          <div>
            <h3>Category</h3>
            <select id="categorySelect">
              <option value="all">All</option>
            </select>
          </div>

          <div>
            <h3>Assets</h3>
            <div id="assetGrid" class="asset-grid">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="selected-item">
            <canvas id="selectedAssetPreview" width="48" height="48"></canvas>
            <div>
              <div id="selectedAssetName">None selected</div>
              <div class="map-info" id="selectedAssetSize">Click asset to select</div>
            </div>
          </div>
          <button id="editSpriteBtn" style="width: 100%; margin-top: 8px; background: #8e44ad;">Edit Sprite Pieces</button>

          <!-- Properties Panel (shown when entity selected on map) -->
          <div id="propertiesPanel" class="properties-panel hidden">
            <h3>Properties</h3>
            <div class="prop-row">
              <label>Name:</label>
              <input type="text" id="propName" placeholder="Entity name">
            </div>
            <div class="prop-row">
              <label>URL:</label>
              <input type="text" id="propUrl" placeholder="https://...">
            </div>
            <div class="prop-row">
              <label>Interactive:</label>
              <input type="checkbox" id="propInteractive">
            </div>
            <div class="prop-row">
              <label>Position:</label>
              <span id="propPosition">-</span>
            </div>
            <button class="delete-btn" id="deleteEntityBtn">Delete Entity</button>
          </div>
        </div>

        <!-- Common controls -->
        <div>
          <h3>Map Size</h3>
          <div class="controls-row">
            <label>W: <input type="number" id="mapWidth" value="50" min="10" max="200"></label>
            <label>H: <input type="number" id="mapHeight" value="45" min="10" max="200"></label>
            <button id="resizeBtn">Resize</button>
          </div>
        </div>

        <div class="instructions">
          <h3>Shortcuts</h3>
          <p>E: Eraser | F: Fill | 1-3: Layers</p>
          <p>[ / ]: Brush size | Wheel: Size</p>
          <p>Del: Delete | Arrows: Move entity</p>
        </div>
      </div>
    </div>

    <div class="map-area">
      <canvas id="mapCanvas"></canvas>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="zoom-controls">
      <span>Zoom:</span>
      <button id="zoomOut">-</button>
      <span id="zoomLevel">2x</span>
      <button id="zoomIn">+</button>
    </div>
    <div class="map-info" id="cursorInfo">Cursor: -</div>
  </div>

  <!-- Tileset Builder Modal -->
  <div id="tilesetBuilderModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Tileset Builder</h2>
        <button class="modal-close" id="closeTilesetModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="tilesetListView">
          <p style="color: #888; margin-bottom: 12px;">
            Combine multiple tilesets into one for easier organization.
          </p>
          <div id="virtualTilesetList">
            <!-- Virtual tilesets will be rendered here -->
          </div>
          <button id="createTilesetBtn" style="width: 100%; margin-top: 12px;">+ Create Virtual Tileset</button>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="exportDefinitionsBtn" style="flex: 1; font-size: 12px;">Export Definitions</button>
            <button id="importDefinitionsBtn" style="flex: 1; font-size: 12px;">Import Definitions</button>
          </div>
          <input type="file" id="importDefinitionsInput" accept=".json" style="display: none;">
        </div>

        <div id="tilesetEditView" class="hidden">
          <div class="form-group">
            <label>Tileset Name</label>
            <input type="text" id="editTilesetName" placeholder="e.g., Grass, Buildings">
          </div>
          <div class="form-group">
            <label>Source Tilesets (order matters - tiles are numbered top to bottom)</label>
            <div class="source-list" id="selectedSources">
              <div style="color: #666; text-align: center; padding: 20px;">
                Click sources below to add them
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Available Sources</label>
            <div class="available-sources" id="availableSources">
              <!-- Source buttons rendered by JS -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelTilesetEdit" class="hidden">Cancel</button>
        <button id="saveTilesetBtn" class="hidden">Save Tileset</button>
      </div>
    </div>
  </div>

  <!-- Sprite Slicer Modal -->
  <div id="spriteSlicerModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Sprite Slicer</h2>
        <button class="modal-close" id="closeSlicerModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="slicer-controls">
          <label>
            Sprite:
            <select id="slicerFileSelect">
              <option value="">-- Select Sprite --</option>
            </select>
          </label>
          <label>
            Grid:
            <select id="slicerGridSize">
              <option value="8">8px</option>
              <option value="16" selected>16px</option>
              <option value="32">32px</option>
            </select>
          </label>
          <label>
            Zoom:
            <select id="slicerZoom">
              <option value="1">1x</option>
              <option value="2" selected>2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
            </select>
          </label>
        </div>

        <div class="slicer-canvas-wrapper">
          <canvas id="slicerCanvas"></canvas>
        </div>
        <p class="slicer-hint">Click on the image to add/remove vertical split lines. Lines snap to grid.</p>

        <h3 style="margin: 12px 0 8px;">Pieces</h3>
        <div id="slicerPieces" class="slicer-pieces">
          <div style="color: #666; padding: 20px; text-align: center; width: 100%;">
            Select a sprite and add splits to define pieces
          </div>
        </div>

        <h3 style="margin: 12px 0 8px;">Output</h3>
        <div class="slicer-output">
          <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
            <button id="copySlicerOutput">Copy to Clipboard</button>
            <button id="applySlicerOutput" style="background: #27ae60;">Apply Changes</button>
          </div>
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 12px;">
            <input type="checkbox" id="slicerReplaceOriginal" checked>
            Replace original piece definitions
          </label>
          <pre id="slicerCodeOutput">// Select a sprite to generate code</pre>
        </div>

        <div id="slicerOverridesSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #0f3460;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="margin: 0;">Applied Overrides</h3>
            <div style="display: flex; gap: 8px;">
              <button id="exportOverridesBtn" class="btn-small" title="Export overrides as JSON for baking into asset-library.js">Export</button>
              <button id="clearOverridesBtn" class="btn-small btn-danger" title="Clear all localStorage overrides">Clear All</button>
            </div>
          </div>
          <div id="slicerOverridesList" style="font-size: 12px; color: #888;">
            No overrides applied yet
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="js/map-editor.js"></script>
</body>
</html>
