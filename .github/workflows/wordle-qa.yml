# Wordle QA - AI-powered browser testing using Claude Code Action
#
# Triggers:
# 1. Automatically when Wordle-related files change
# 2. Manually when 'qa-verify' label is added to any PR
#
# Uses anthropics/claude-code-action@v1 with Playwright MCP for browser automation.
# Based on: https://alexop.dev/posts/building_ai_qa_engineer_claude_code_playwright/

name: Wordle QA

on:
  push:
    branches: [main]
    paths:
      - 'wordle/**'
      - 'server/src/rooms/wordle-*'
      - 'server/src/services/wordle-*'
      - 'server/src/utils/daily-word.ts'
      - 'server/src/utils/word-list.ts'
  pull_request:
    paths:
      - 'wordle/**'
      - 'server/src/rooms/wordle-*'
      - 'server/src/services/wordle-*'
      - 'server/src/utils/daily-word.ts'
      - 'server/src/utils/word-list.ts'
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [labeled]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for claude-code-action OIDC auth

jobs:
  wordle-qa:
    # Run if: push, workflow_dispatch, PR with wordle files, OR qa-verify label
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_target' && github.event.label.name == 'qa-verify')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: Build application
        run: npm run build

      - name: Start server
        run: |
          cd server && npm start &
          echo "Waiting for server..."
          for i in {1..30}; do
            if curl -s http://localhost:2567/health > /dev/null; then
              echo "Server ready!"
              break
            fi
            sleep 2
          done

      - name: Claude QA Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are Quinn, a meticulous QA engineer testing Wordle Battle.

            ## PR Context
            **Title**: ${{ github.event.pull_request.title }}
            **Description**: ${{ github.event.pull_request.body }}

            ## Test Instructions
            Navigate to http://localhost:2567/wordle and verify:

            1. **Lobby loads correctly**
               - Three main buttons visible: Daily Challenge, Play With Friends, Past Dailies
               - No console errors

            2. **Daily Challenge flow**
               - Click Daily Challenge
               - Verify game board appears
               - Type a valid 5-letter word and submit
               - Verify feedback (colors) appears

            3. **Create Room flow**
               - Click Play With Friends
               - Click Create Room
               - Verify room code is generated
               - Verify settings panel works

            4. **Mobile viewport**
               - Resize to 375x667 (iPhone SE)
               - Verify UI is usable (no overlapping elements)

            ## Output Format
            Report your findings as:

            ## QA Verification Report

            **Verdict**: PASS / PASS WITH NOTES / FAIL

            ### Tested
            - [x] Item that passed
            - [ ] Item that failed (with details)

            ### Issues Found
            (If any - include severity and steps to reproduce)

            ### Screenshots
            (Reference any screenshots taken)

            Take screenshots of any issues you find.
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
            --allowedTools "mcp__playwright__browser_navigate,mcp__playwright__browser_click,mcp__playwright__browser_type,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_press_key,mcp__playwright__browser_wait_for"
